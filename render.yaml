services:
  # The Spring Boot Backend Service
  - type: web
    name: family-finance-backend
    env: spring
    plan: free
    rootDir: ./backend
    buildCommand: "./gradlew bootJar"
    startCommand: "java -jar build/libs/*.jar"
    envVars:
      - key: SPRING_DATASOURCE_URL
        fromService:
          type: pserv
          name: family-finance-db
          property: connectionString
      - key: SPRING_DATASOURCE_USERNAME
        fromService:
          type: pserv
          name: family-finance-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromService:
          type: pserv
          name: family-finance-db
          property: password
      - key: SPRING_REDIS_HOST
        fromService:
          type: redis
          name: family-finance-cache
          property: host
      - key: SPRING_REDIS_PORT
        fromService:
          type: redis
          name: family-finance-cache
          property: port
      - key: SPRING_PROFILES_ACTIVE
        value: prod

  # The React Frontend Static Site
  - type: web
    name: family-finance-frontend
    env: static
    plan: free
    rootDir: ./
    buildCommand: "npm install && npm run build"
    staticPublishPath: ./dist
    routes:
      - type: rewrite
        source: "/*"
        destination: "/index.html"
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: family-finance-backend
          property: url

  # The PostgreSQL Database
  - type: pserv
    name: family-finance-db
    env: postgres # This specifies the database type
    plan: free
    # By removing postgresMajorVersion, we let Render choose the best supported version

  # The Redis Cache
  - type: redis
    name: family-finance-cache
    plan: free